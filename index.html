<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<!-- <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script> -->
	<script src="./jweixin-1.6.0.js"></script>
	
  <title>æ–‡ä»¶ä¸Šä¼ </title>
  <style>
    /* åŸºç¡€æ ·å¼ä¿æŒä¸å˜ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    
    body {
      background-color: #f9f9f9;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    
    .container {
      width: 100%;
      max-width: 400px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 24px;
    }
    
    .title-area {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 14px;
      color: #666;
    }
    
    .select-mode {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .mode-option {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .mode-option input {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      accent-color: #37C2FF;
    }
    
    .mode-option label {
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }
    
    .upload-btn {
      width: 100%;
      padding: 12px;
      background-color: #37C2FF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      margin-bottom: 16px;
    }
    
    .upload-btn:hover {
      background-color: #29b8ff;
    }
    
    .upload-btn:disabled {
      background-color: #b3e0ff;
      cursor: not-allowed;
    }
    
    .upload-btn i {
      margin-right: 8px;
    }
    
    .status-message {
      display: none;
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .status-success {
      display: block;
      background-color: #f0fff4;
      color: #00b42a;
      border: 1px solid #b3f0c5;
    }
    
    .status-error {
      display: block;
      background-color: #fff0f0;
      color: #f53f3f;
      border: 1px solid #ffd2d2;
    }
    
    #fileInput {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="title-area">
      <h1 class="title">æ–‡ä»¶ä¸Šä¼ </h1>
      <!-- <p class="subtitle">æ”¯æŒæ‰€æœ‰ç±»å‹æ–‡ä»¶çš„ä¸Šä¼ ï¼ˆå«Base64è½¬æ¢ï¼‰</p> -->
      <p class="subtitle">æ”¯æŒæ‰€æœ‰ç±»å‹æ–‡ä»¶çš„ä¸Šä¼ </p>
    </div>
    
    <div class="select-mode">
      <div class="mode-option">
        <input type="radio" name="selectMode" id="singleMode" value="single" checked>
        <label for="singleMode">å•ä¸ªæ–‡ä»¶</label>
      </div>
      <div class="mode-option">
        <input type="radio" name="selectMode" id="multipleMode" value="multiple">
        <label for="multipleMode">å¤šä¸ªæ–‡ä»¶</label>
      </div>
    </div>
    
    <input type="file" id="fileInput" accept="*/*">
    <button id="uploadBtn" class="upload-btn">
      <span>ğŸ“¤</span> é€‰æ‹©å¹¶ä¸Šä¼ æ–‡ä»¶
    </button>
    <div id="statusMessage" class="status-message"></div>
  </div>

  <script>
    // DOMå…ƒç´ 
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const statusMessage = document.getElementById('statusMessage');
    const singleModeRadio = document.getElementById('singleMode');
    const multipleModeRadio = document.getElementById('multipleMode');

    // æ ¸å¿ƒé…ç½®ï¼šå¾®ä¿¡å°ç¨‹åºBase64åˆ†ç‰‡å¤§å°ï¼ˆé»˜è®¤200KBï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
    // const WX_MINIPROGRAM_CHUNK_SIZE = 200 * 1024; // 200KB
    const WX_MINIPROGRAM_CHUNK_SIZE = 2 * 1024;

    try{
      // H5 æ—¥å¿—åŒæ­¥åˆ°å°ç¨‹åº
      const originalLog = console.log;
      console.log = function(...args) {
        originalLog.apply(console, args);
        if (window.wx?.miniProgram) {
          wx.miniProgram.postMessage({
            data: {
              type: 'h5_log',
              content: args.join(' ')
            }
          });
        }
      };
    }catch{}
    
    // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡å°ç¨‹åºç¯å¢ƒ
    function isWechatMiniProgram() {
      const userAgent = window.navigator.userAgent.toLowerCase();
      return userAgent.includes('miniprogram');
    }
    
    // æ›´æ–°æ–‡ä»¶é€‰æ‹©æ¨¡å¼
    function updateFileSelectionMode() {
      const isMultiple = multipleModeRadio.checked;
      fileInput.multiple = isMultiple;
    }
    
    // ç»‘å®šé€‰æ‹©æ¨¡å¼å˜æ›´äº‹ä»¶
    singleModeRadio.addEventListener('change', updateFileSelectionMode);
    multipleModeRadio.addEventListener('change', updateFileSelectionMode);
    
    // ç‚¹å‡»ä¸Šä¼ æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
    uploadBtn.addEventListener('click', () => {
      updateFileSelectionMode();
      fileInput.click();
    });
    
    // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶ï¼ˆæ–°å¢asyncï¼Œæ”¯æŒawaitè°ƒç”¨Base64è½¬æ¢ï¼‰
    fileInput.addEventListener('change', async () => {
      if (fileInput.files.length > 0) {
        await handleFiles(fileInput.files); // æ”¹ä¸ºå¼‚æ­¥ï¼Œç­‰å¾…Base64è½¬æ¢å®Œæˆ
      }
    });
    
    // å¤„ç†æ–‡ä»¶ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šåŠ å…¥Base64è½¬æ¢ï¼‰
    async function handleFiles(files) {
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<span>âŒ›</span> å¤„ç†ä¸­...';
      
      try {
        // 1. å°†æ–‡ä»¶è½¬ä¸ºBase64æ ¼å¼ï¼ˆè°ƒç”¨å®Œå–„åçš„è½¬æ¢å‡½æ•°ï¼‰
        const fileInfoList = await getFilesBase64(files);
        if (fileInfoList.length === 0) {
          throw new Error('æ–‡ä»¶è½¬æ¢å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
        
        // 2. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        statusMessage.textContent = `æˆåŠŸè½¬æ¢ ${fileInfoList.length} ä¸ªæ–‡ä»¶`;
        statusMessage.className = 'status-message status-success';
        
        // 3. æŒ‰ç¯å¢ƒå¤„ç†
        if (isWechatMiniProgram()) {
          await handleMiniProgramUpload(fileInfoList); // å°ç¨‹åºåˆ†ç‰‡ä¼ è¾“
        } else {
          handleWebUpload(fileInfoList); // Webç«¯æ‰“å°ä¿¡æ¯
        }
      } catch (e) {
        // é”™è¯¯å¤„ç†
        console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', e);
        statusMessage.textContent = e.message || 'å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•';
        statusMessage.className = 'status-message status-error';
        resetUploadButton();
      }
    }
    
    // å¤„ç†å°ç¨‹åºç¯å¢ƒä¸‹çš„ä¸Šä¼ ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šåˆ†ç‰‡ä¼ è¾“å¤§Base64æ•°æ®ï¼‰
    async function handleMiniProgramUpload(fileInfoList) {
      if (!window.wx || !wx.miniProgram) {
        throw new Error('å°ç¨‹åºç¯å¢ƒå¼‚å¸¸');
      }
      
      // å»¶è¿Ÿæ˜¾ç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒ
      await new Promise(resolve => setTimeout(resolve, 800));
      
      try {
        // éå†æ¯ä¸ªæ–‡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†ç‰‡
        for (const file of fileInfoList) {
          const base64Data = file.base64;
          // ç§»é™¤Base64å‰ç¼€ï¼ˆå¦‚"data:image/png;base64,"ï¼‰ï¼Œä»…ä¿ç•™åŸå§‹ç¼–ç 
          const pureBase64 = base64Data.split(',')[1] || base64Data;
          
          // åˆ¤æ–­æ–‡ä»¶å¤§å°ï¼šè¶…è¿‡åˆ†ç‰‡é˜ˆå€¼åˆ™åˆ†ç‰‡ï¼Œå¦åˆ™ç›´æ¥ä¼ è¾“
          if (pureBase64.length > WX_MINIPROGRAM_CHUNK_SIZE) {
            // åˆ†ç‰‡é€»è¾‘
            const totalChunks = Math.ceil(pureBase64.length / WX_MINIPROGRAM_CHUNK_SIZE);
            for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
              // è®¡ç®—å½“å‰åˆ†ç‰‡çš„èµ·å§‹å’Œç»“æŸä½ç½®
              const start = chunkIndex * WX_MINIPROGRAM_CHUNK_SIZE;
              const end = Math.min((chunkIndex + 1) * WX_MINIPROGRAM_CHUNK_SIZE, pureBase64.length);
              const chunkData = pureBase64.slice(start, end);
              
              // å‘é€åˆ†ç‰‡æ¶ˆæ¯ï¼ˆå«æ–‡ä»¶æ ‡è¯†ã€åˆ†ç‰‡ç´¢å¼•ã€æ€»ç‰‡æ•°ï¼‰
              wx.miniProgram.postMessage({
                data: {
                  type: 'fileChunk', // åˆ†ç‰‡æ¶ˆæ¯ç±»å‹
                  fileId: file.name + '_' + file.lastModified, // å”¯ä¸€æ ‡è¯†æ–‡ä»¶ï¼ˆé¿å…åŒåå†²çªï¼‰
                  chunkIndex: chunkIndex, // å½“å‰åˆ†ç‰‡ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
                  totalChunks: totalChunks, // æ€»åˆ†ç‰‡æ•°
                  chunkData: chunkData, // å½“å‰åˆ†ç‰‡çš„Base64æ•°æ®
                  fileMeta: { // æ–‡ä»¶å…ƒä¿¡æ¯ï¼ˆåç§°ã€å¤§å°ã€ç±»å‹ï¼‰
                    name: file.name,
                    size: file.size,
                    type: file.type
                  }
                }
              });
            }
          } else {
            // å°æ–‡ä»¶ï¼šç›´æ¥ä¼ è¾“å®Œæ•´Base64
            wx.miniProgram.postMessage({
              data: {
                type: 'fileComplete', // å®Œæ•´æ–‡ä»¶æ¶ˆæ¯ç±»å‹
                file: {
                  ...file,
                  base64: pureBase64 // ç§»é™¤å‰ç¼€åçš„çº¯å‡€Base64
                }
              }
            });
          }
        }
        
        // æ‰€æœ‰æ–‡ä»¶ä¼ è¾“å®Œæˆåï¼Œå‘é€ç»“æŸæ ‡è¯†
        wx.miniProgram.postMessage({
          data: {
            type: 'allFilesSent', // å…¨éƒ¨å®Œæˆæ ‡è¯†
            totalFiles: fileInfoList.length
          }
        });
        
        // è¿”å›å°ç¨‹åºä¸Šä¸€é¡µ
        wx.miniProgram.navigateBack({ delta: 1 });
      } catch (e) {
        throw new Error('å°ç¨‹åºä¼ è¾“å¤±è´¥: ' + e.message);
      }
    }
    
    // å¤„ç†Webç¯å¢ƒä¸‹çš„ä¸Šä¼ ï¼ˆä¿®æ”¹ï¼šæ‰“å°åŒ…å«Base64çš„æ–‡ä»¶ä¿¡æ¯ï¼‰
    function handleWebUpload(fileInfoList) {
      // å»¶è¿Ÿå¤„ç†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°çŠ¶æ€æç¤º
      setTimeout(() => {
        printFileInfo(fileInfoList);
        resetUploadButton();
      }, 800);
    }
    
    // æ‰“å°æ–‡ä»¶ä¿¡æ¯ï¼ˆæ–°å¢ï¼šæ˜¾ç¤ºBase64æ‘˜è¦ï¼Œé¿å…æ—¥å¿—è¿‡é•¿ï¼‰
    function printFileInfo(files) {
      console.log('=== Webç«¯ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯ ===', files);
      
      // // æ„å»ºç®€åŒ–çš„æ‰“å°å†…å®¹ï¼ˆæ˜¾ç¤ºBase64å‰50ä¸ªå­—ç¬¦ï¼Œé¿å…æ—¥å¿—è‡ƒè‚¿ï¼‰
      // const printData = files.map(file => ({
      //   name: file.name,
      //   size: formatFileSize(file.size),
      //   type: file.type,
      //   base64Preview: file.base64.slice(0, 50) + '...' // Base64é¢„è§ˆï¼ˆå‰50å­—ç¬¦ï¼‰
      // }));
      
      // // æ‰“å°ç®€åŒ–ä¿¡æ¯ï¼Œå®Œæ•´ä¿¡æ¯å¯æŸ¥çœ‹ä¸Šæ–¹fileså˜é‡
      // console.log('=== ç®€åŒ–æ–‡ä»¶ä¿¡æ¯ï¼ˆBase64é¢„è§ˆï¼‰ ===', printData);
      
      // å¯é€‰ï¼šå¼¹å‡ºæç¤ºæ¡†å‘ŠçŸ¥ç”¨æˆ·
      // alert(`Webç«¯å·²å®Œæˆæ–‡ä»¶è½¬æ¢ï¼Œå…± ${files.length} ä¸ªæ–‡ä»¶ï¼Œè¯¦æƒ…è§æ§åˆ¶å°æ—¥å¿—`);
    }
    
    // å®Œå–„æ–‡ä»¶è½¬Base64å‡½æ•°ï¼ˆä¿®å¤åŸä»£ç bugï¼Œç¡®ä¿æ­£ç¡®è½¬æ¢ï¼‰
    async function getFilesBase64(files) {
      const fileArray = Array.from(files); // å°†FileListè½¬ä¸ºæ•°ç»„
      if (fileArray.length === 0) return [];
      
      // éå†æ–‡ä»¶ï¼Œå¹¶è¡Œè½¬æ¢ä¸ºBase64
      const filePromises = fileArray.map(file => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          
          // è½¬æ¢æˆåŠŸï¼šè¿”å›åŒ…å«Base64çš„æ–‡ä»¶ä¿¡æ¯
          reader.onload = (e) => {
            resolve({
              name: file.name,
              size: file.size,
              type: file.type,
              lastModified: file.lastModified,
              lastModifiedDate: new Date(file.lastModified).toISOString(),
              base64: e.target.result // å®Œæ•´Base64ï¼ˆå«å‰ç¼€ï¼Œå¦‚"data:image/png;base64,"ï¼‰
            });
          };
          
          // è½¬æ¢å¤±è´¥ï¼šæ‰“å°é”™è¯¯å¹¶è¿”å›null
          reader.onerror = () => {
            console.error(`æ–‡ä»¶è½¬æ¢å¤±è´¥: ${file.name}`);
            resolve(null);
          };
          
          // ä»¥DataURLæ ¼å¼è¯»å–æ–‡ä»¶ï¼ˆç”ŸæˆBase64ï¼‰
          reader.readAsDataURL(file);
        });
      });
      
      // ç­‰å¾…æ‰€æœ‰è½¬æ¢å®Œæˆï¼Œè¿‡æ»¤å¤±è´¥çš„æ–‡ä»¶
      const results = await Promise.all(filePromises);
      return results.filter(Boolean); // ç§»é™¤nullï¼ˆè½¬æ¢å¤±è´¥çš„æ–‡ä»¶ï¼‰
    }
    
    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°ï¼ˆä¿æŒä¸å˜ï¼‰
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // é‡ç½®ä¸Šä¼ æŒ‰é’®çŠ¶æ€ï¼ˆä¿æŒä¸å˜ï¼‰
    function resetUploadButton() {
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = '<span>ğŸ“¤</span> é€‰æ‹©å¹¶ä¸Šä¼ æ–‡ä»¶';
      statusMessage.className = 'status-message';
    }
    
    // åˆå§‹åŒ–å¾®ä¿¡å°ç¨‹åºç¯å¢ƒæ£€æµ‹ï¼ˆä¿æŒä¸å˜ï¼‰
    function initWechatMiniProgram() {
      if (typeof wx !== 'undefined' && wx.miniProgram) {
        wx.miniProgram.getEnv((res) => {
          if (res.miniprogram) {
            console.log('å½“å‰åœ¨å¾®ä¿¡å°ç¨‹åºç¯å¢ƒï¼ŒBase64åˆ†ç‰‡å¤§å°ï¼š', WX_MINIPROGRAM_CHUNK_SIZE, 'å­—èŠ‚');
          }
        });
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆä¿æŒä¸å˜ï¼‰
    window.addEventListener('DOMContentLoaded', () => {
      initWechatMiniProgram();
      updateFileSelectionMode();
    });
  </script>
</body>
</html>
